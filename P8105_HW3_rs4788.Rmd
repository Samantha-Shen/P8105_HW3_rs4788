---
title: "P8105_HW3_rs4788"
output: html_document
author: Ruhui Shen
date: "2025-10-12"
---

```{r setup}
library(tidyverse)
library(viridis) 
library(tidyr)
library(janitor)
library(patchwork)
library(ggplot2)
library(dplyr)
```

# Problem 1

### First load the data:

```{r}
library(p8105.datasets)
data("instacart")
glimpse(instacart)
```

### Take a look at the data:
```{r}
instacart_summary =
  instacart %>%
  summarise(
    n_obs = n(),
    n_vars = ncol(.),
    n_users = n_distinct(user_id),
    n_orders = n_distinct(order_id),
    n_products = n_distinct(product_id),
    n_aisles = n_distinct(aisle),
    n_departments = n_distinct(department)
  )

instacart_summary
```
This dataset records orders and products information from the Instacart platform, describing items within specific orders. It contains 1,384,617 observations across 15 variables, covering 131,209 users and 131,209 orders. The dataset includes 39,123 distinct products distributed across 134 aisles and 21 departments.



### Let's make more detailed description:
#### aisles_items:
```{r}
aisle_counts =
  instacart %>%
  count(aisle, name = "n_items") %>%
  arrange(desc(n_items))
aisle_counts
```
There are 134 aisles. In terms of order times, fresh vegetables and fresh fruits are much higher than other aisles, with packaged vegetables and fruits ranking third. This demonstrates the high demand for fruits and vegetables, which are essential daily necessities.


#### Plot for aisle & items_number:
```{r}
aisle_plot_data =
  aisle_counts %>%
  filter(n_items > 10000) %>%
  mutate(aisle = forcats::fct_reorder(aisle, n_items))

aisle_plot =
  ggplot(aisle_plot_data, aes(x = aisle, y = n_items)) +
  geom_col(fill = "steelblue") +
  coord_flip(clip = "off") +
  geom_text(aes(label = scales::comma(n_items)),
            hjust = -0.1, size = 2.5) +
  labs(
    title = "Number of items ordered by aisle (> 10,000 only)",
    x = "Aisle",
    y = "Number of items") +
  theme_minimal() +
  theme(plot.margin = margin(5.5, 60, 5.5, 5.5))
aisle_plot
```

#### Popular items in some aisles:

```{r}
target_aisles = c("baking ingredients", "dog food care", "packaged vegetables fruits")

most_popular =
  instacart %>%
  filter(aisle %in% target_aisles) %>%
  group_by(aisle, product_name) %>%
  summarise(n = n(), .groups = "drop_last") %>%
  arrange(desc(n)) %>%
  group_by(aisle) %>%
  slice_max(order_by = n, n = 3, with_ties = FALSE) %>%
  mutate(rank = row_number()) %>%  
  ungroup() %>%
  pivot_wider(
    id_cols   = aisle,
    names_from  = rank,
    values_from = c(product_name, n))

most_popular %>%
  knitr::kable(caption = "The three most popular items in the aisles")
```


#### Mean order hour during a week:

```{r}
dow_labs = c("Sun","Mon","Tue","Wed","Thu","Fri","Sat")

mean_hour_day=
  instacart %>%
  filter(product_name %in% c("Pink Lady Apples", "Coffee Ice Cream")) %>%
  mutate(order_dow = factor(order_dow, levels = 0:6, labels = dow_labs)) %>%
  group_by(product_name, order_dow) %>%
  summarise(mean_hour = mean(order_hour_of_day), .groups = "drop") %>%
  pivot_wider(
    names_from = order_dow, 
    values_from = mean_hour
  )

mean_hour_day %>%
  knitr::kable(digits = 1, caption = "Mean order hour on each day of the week")
```



# Problem 2

### Import, clean, and tidy data:
```{r}
zip_code =
  read_csv("./zillow_data/Zip Codes.csv") %>%
  janitor::clean_names()

zip_zori =
  read_csv("./zillow_data/Zip_zori_uc_sfrcondomfr_sm_month_NYC.csv") %>%
  janitor::clean_names() %>%
  mutate(region_name = as.character(region_name))
```

```{r}
zori_long =
  zip_zori %>%
  rename(zip_code = region_name) %>%        
  pivot_longer(
    cols = matches("^x?\\d{4}[_-]\\d{2}([_-]\\d{2})?$"), 
    names_to  = "date_raw",
    values_to = "rent"
  ) %>%
  mutate(
    date_raw = as.character(date_raw),
    date_raw = str_remove(date_raw, "^x"),
    date_raw = str_replace_all(date_raw, "_", "-"),
    date_raw = if_else(str_detect(date_raw, "^\\d{4}-\\d{2}$"),
                       paste0(date_raw, "-01"), date_raw),
    date = ymd(date_raw)
  ) %>%
  select(zip_code, date, rent) %>%
  drop_na(rent)
```

```{r}
zip_borough =
  zip_code %>%
  transmute(
    zip_code = as.character(zip_code),
    county   = str_to_lower(county) |> 
               str_trim() |>
               str_replace("\\s+county$", "")) %>%
  mutate(
    borough = case_when(
      county == "new york"  ~ "Manhattan",
      county == "kings"      ~ "Brooklyn",
      county == "queens"     ~ "Queens",
      county == "bronx"      ~ "The Bronx",
      county == "richmond"   ~ "Staten Island",
      TRUE ~ NA_character_
    )) %>%
  select(zip_code, borough)
```

```{r}
zori <-
  zori_long %>%
  left_join(zip_borough, by = "zip_code",relationship = "many-to-many") %>%
  drop_na(borough)
zori
```


### Answer some questions:

#### Zip code count:
```{r}
zip_count =
  zori_long %>%
  filter(date >= ymd("2015-01-01"), date <= ymd("2024-08-31")) %>%  
  group_by(zip_code) %>%
  summarise(n_months = n_distinct(date), .groups = "drop") %>%
  summarise(zips_116 = sum(n_months == 116),
            zips_lt10 = sum(n_months < 10))
zip_count
```
Between January 2015 and August 2024, 48 ZIP codes are observed 116 times, while 26 ZIP codes are observed fewer than 10 times. This is because rarely observed ZIPs are typically boundary or newly created or retired ZIP codes, areas with very sparse listings, so they don’t receive a ZORI every month. However, well-covered ZIPs have consistent monthly data across the whole window.

#### Average rental price in brough and year:

```{r}
avg_price <-
  zori %>%
  group_by(borough, year = year(date)) %>%
  summarise(avg_rent = mean(rent, na.rm = TRUE), .groups = "drop") %>%
  mutate(borough = fct_relevel(borough, "Manhattan","Brooklyn","Queens","The Bronx","Staten Island")) %>%
  arrange(borough, year) %>%
  pivot_wider(names_from = year, values_from = avg_rent) %>%
  knitr::kable(digits = 0, caption = "Average rental price in each borough and year")

avg_price
```
Looking at the annual average rent data, according to brought, the rent in Manhattan has been the highest over the years, followed by Brooklyn, Queens, and The Bronx and Staten Island have the lowest rents. 
From the timeline perspective, the rent in New York continued to rise from 2015 to 2019. It then entered a stagnation period or even slightly declined in 2020 and 2021. However, it rebounded in 2022 and has been continuously rising ever since.


#### Plot for rental price within ZIP code：
```{r}
zip_year =
  zori %>%
  group_by(borough, zip_code, year = year(date)) %>%
  summarise(rent_year_zip = mean(rent, na.rm = TRUE), .groups = "drop")

borough_year =
  zip_year %>%
  group_by(borough, year) %>%
  summarise(mean_rent = mean(rent_year_zip), .groups = "drop")

price_zip_plot =
  ggplot(zip_year, aes(x = factor(year), y = rent_year_zip)) +
  geom_boxplot() +
  geom_line(
    data = borough_year,
    aes(y = mean_rent, group = 1),
    linewidth = 0.8, color = "steelblue") +
  geom_jitter(width = 0.25, height = 0, alpha = 0.25, size = 0.6) +
  facet_grid(borough ~ ., scales = "free_y") +  
  labs(title = "NYC Rental Prices within ZIP codes for years", x= "Year", y = "Rent Price within Zip") +
  theme(panel.spacing.y = unit(1.2, "lines")) 

price_zip_plot
```
Rental prices vary across boroughs, with annual rental changes consistent with the findings from the previous question. Additionally, rental prices in Brooklyn and Manhattan exhibit a broader distribution within zip codes.


#### Plot for rental price in 2023：

```{r}
rent_2023 =
  zori %>%
  filter(year(date) == 2023) %>%
  mutate(mon_num = month(date),
         mon_f   = factor(mon_num, levels = 1:12, labels = 1:12)) %>%
  group_by(borough, zip_code, mon_f) %>%
  summarise(avg_rent = mean(rent, na.rm = TRUE), .groups = "drop")


borough_month =
  rent_2023 %>%
  group_by(borough, mon_f) %>%
  summarise(mean_rent = mean(avg_rent), .groups = "drop")

price_zip_2023 =
  ggplot(rent_2023, aes(x = mon_f, y = avg_rent)) +
  geom_boxplot() +
  geom_line(data = borough_month,
            aes(y = mean_rent, group = 1),
            linewidth = 0.8, color = "steelblue") +
  geom_jitter(width = 0.25, height = 0, alpha = 0.25, size = 0.6) +
  facet_grid(borough ~ ., scales = "free_y") +
  labs(title = "Average monthly rents within ZIP codes in 2023",
       x = "Month", y = "Rent Price within Zip") +
  theme(panel.spacing.y = unit(1.2, "lines"))

price_zip_2023
```
In terms of monthly rent, Manhattan remains the most expensive, followed by Brooklyn and Queens, while Staten Island and The Bronx have the lowest rates. 
Manhattan and Brooklyn exhibit taller boxes and longer tails, indicating greater rental variation between ZIP codes. 
Overall monthly rental trends show increases across all boroughs from July to September, likely due to the summer peak for international student renting and the tourist season. Rents typically decline back to lower levels after September.


#### Combine the plots:

```{r}
left  = price_zip_plot  +
  labs(subtitle = "2015–2024 by year", y = "Average rent price")

right = price_zip_2023  +
  labs(subtitle = "Year 2023 by month", y = "Average rent price")

combined_plot =
  (left | right) +
  plot_layout(widths = c(1, 1)) +
  plot_annotation(
    title = "NYC Rental Prices within ZIP codes",
    theme = theme(plot.title = element_text(hjust = 0.5, face = "bold"))
  )

combined_plot

ggsave("results/nyc rents sum plot.png", combined_plot,
       width = 16, height = 12, units = "in", dpi = 300, bg = "white")
```


# Problem 3

### Load, tidy, merge, and organize dataset:
```{r}
accel =
  read_csv("./MIMS/nhanes_accel.csv") %>%
  janitor::clean_names()

covar =
  read_csv("./MIMS/nhanes_covar.csv", skip = 4, show_col_types = FALSE) %>%
  janitor::clean_names()


covar_filter =
  covar %>%
  filter(age >= 21) %>%
  drop_na() %>%
  mutate(
    sex = if (is.numeric(sex))
            factor(sex, levels = c(1, 2), labels = c("Male", "Female"))
          else factor(sex),
    education = if (is.numeric(education))
                  factor(education, levels = c(1, 2, 3),
                         labels = c("Less than HS", "HS equivalent", "More than HS"),
                         ordered = TRUE)
                else factor(education, ordered = TRUE))
covar_filter
```
If we need combined dataset:
```{r}
combined_data =
  covar_filter %>%
  inner_join(accel, by = "seqn", relationship = "one-to-one")
```

### sex and education category:

```{r}
edu_sex_tab =
  covar_filter %>%
  count(education, sex, name = "n") %>%
  group_by(education) %>%
  pivot_wider(names_from = sex, values_from = n,values_fill = 0)

knitr::kable(edu_sex_tab, caption = "Number of men and women in each education category")
```

```{r}
age_distri_plot =
  covar_filter %>%
  ggplot(aes(x = sex, y = age, fill = sex)) +
  geom_violin(width = 0.9, trim = FALSE, alpha = 0.5,
              position = position_dodge(width = 0.8), color = NA) +
  facet_wrap(~ education, ncol = 1) +
  labs(
    title = "Age distributions by sex within education category",
    x = "Sex", y = "Age") +
  scale_y_continuous(breaks = seq(20, 80, 10)) +
  theme_minimal() +
  theme(legend.position = "none")

age_distri_plot
```

The table shows that the total gender distribution across different educational levels is relatively balanced. 
Further examination of the age distribution plot by gender within each educational category reveals that low educational levels are concentrated among older age groups, while those with education beyond high school are mainly concentrated among younger individuals. Among those with a high school education, males exhibit a broader age distribution, whereas females show a higher proportion in middle-aged and older groups.
Overall, educational level is related to age but not significantly to gender. This phenomenon may be due to the increasing accessibility of higher education in recent years.


### Total activity:

```{r}
minute_cols = grep("^min\\d+$", names(accel), value = TRUE)

total_activ = 
  accel %>%
  dplyr::mutate(total_activity = rowSums(dplyr::select(., dplyr::all_of(minute_cols)),
                                         na.rm = TRUE)) %>%
  dplyr::select(seqn, total_activity)


final_data =
  covar_filter %>%
  inner_join(total_activ, by = "seqn", relationship = "one-to-one")
final_data


activ_plot =
  ggplot(final_data, aes(x = age, y = total_activity, color = sex)) +
  geom_point(alpha = 0.8, size = 1) +
  geom_smooth(se = FALSE, method = "loess", linewidth = 1) +
  facet_wrap(~ education, ncol = 1) +
  labs(
    title = "Total daily activity vs Age by sex and education",
    x = "Age",
    y = "MIMS",
    color = "Sex") +
  theme_minimal(base_size = 12) +
  theme(legend.position = "top")
activ_plot
```
As shown in the plot, MIMS declines with increasing age. By gender, women generally exhibit slightly higher MIMS than men, except in the group with less than a high school education, where middle-aged and older men show slightly higher MIMS than women. The overall activity levels across the three education groups are generally comparable. Overall, in this sample, age is the primary factor driving the decline in activity levels; differences attributable to gender and education level are relatively slight.


### 24-hour activity time courses:

```{r}
minute_cols = grep("^min\\d+$", names(combined_data), value = TRUE)

hour_activ =
  combined_data %>%
  pivot_longer(all_of(minute_cols), names_to = "minute", values_to = "mims") %>%
  mutate(
    minute_num = as.integer(str_remove(minute, "^min")),
    hour = floor((minute_num - 1) / 60) +1 ) %>%
  group_by(seqn, sex, age, bmi, education, hour) %>%
  summarise(mims_hour = mean(mims, na.rm = TRUE), .groups = "drop")

day_activ_plot =
  ggplot(hour_activ, aes(x = hour, y = mims_hour, color = sex)) +
  geom_point(alpha = 0.5, size = 0.4) +
  geom_smooth(se = FALSE, method = "loess", span = 0.3, linewidth = 1) +
  facet_grid(rows = vars(education), scales = "free_y") +
  scale_x_continuous(breaks = seq(1, 24, by = 3), limits = c(1, 24)) +
  scale_y_continuous(limits = c(0, NA), expand = expansion(mult = c(0.02, 0.05))) +
  labs(title = "24-hour activity time courses by education",
       x = "Hour of day", y = "Hourly MIMS", color = "Sex") +
  theme_minimal()
day_activ_plot
```

The daily activity level trajectory shows that MMS is lowest in the early morning, gradually rising from around 6 to 7 a.m., peaking at noon, and remaining high throughout the afternoon before declining significantly around 8 to 10 p.m. This daily activity pattern is consistent with human circadian rhythms. The shape of the curve is similar across different educational levels. Women's curves are generally slightly higher than men's during daytime hours.





